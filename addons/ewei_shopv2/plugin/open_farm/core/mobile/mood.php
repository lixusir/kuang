<?php/* * 人人商城 * * 青岛易联互动网络科技有限公司 * http://www.we7shop.cn * TEL: 4000097827/18661772381/15865546761 */if (!defined('IN_IA')) {    exit('Access Denied');}require_once 'chicken.php';class Mood_EweiShopV2Page extends PluginMobilePage {    /**     * 当前数据表名称     * @var string     */    private $table = 'ewei_open_farm_mood';    /**     * 当前数据表名称     * @var string     */    private $sonTable = 'ewei_open_farm_mood_image';    /**     * 当前类的所有字段     * @var array     */    private $field = array(        'id',        'uniacid',        'logo',        'create_time',    );    /**     * 当前类的所有字段     * @var array     */    private $sonField = array(        'id',        'uniacid',        'picture',        'create_time',    );    /**     * 需要验证是否非空的字段以及其回复     * @var array     */    private $message = array(        'logo' => '请选择心情logo',        'picture_list' => '请选择心情图',    );    /**     * 默认openid     * @var string     */    private $openid = '';    /**     * 初始化接口     */    public function __construct() {        parent::__construct();        global $_W;        $_W['openid'] = $_W['openid'];    }    /**     * 首页方法     */    public function main() {        require_once $this->template();    }    /**     * 获取信息     */    public function getInfo() {        global $_W;        $where = array(            'uniacid' => $_W['uniacid']        );        $moodInfo = pdo_get($this->table, $where);        $moodInfo['show_logo'] = tomedia($moodInfo['logo']);        $moodInfo['picture_list'] = $this->getSon();        $this->model->returnJson($moodInfo);    }    /**     * 获取子表数据     */    public function getSon() {        global $_W;        $where = array(            'uniacid' => $_W['uniacid']        );        $list = pdo_getall($this->sonTable, $where);        $list = $this->model->forTomedia($list, 'picture', 'show_picture');        $data = array();        foreach ($list as $item) {            $data[] = $item;        }        return $data;    }    /**     * 生成心情卡图片     */    public function generateMood() {        global $_W, $_GPC;        // 设置当前用户信息        $data = array(            'uniacid' => $_W['uniacid'],            'openid' => $_W['openid'],        );        // 获取当前用户的分享链接        $url = mobileUrl('open_farm', $data, true);        // 加载二维码生成类        load()->library('qrcode');        // 设置二维码内容        $content = $url;        // 错误校正级别        $errorCorrectionLevel = "L";        // 设置文件夹        $qrCodeFolder = __DIR__ . '/../../static/mobile/qr_code/';        // 判断该文件夹是否存在        if (!file_exists($qrCodeFolder)) {            // 不存在则生成文件夹            mkdir($qrCodeFolder, 0777, true);;        }        // 设置当前用户的二维码本地暂存文件名        $qrCodeName = $_W['uniacid'] . '-' . $_W['openid'] . '.png';        // 设置文件上传插件上传图片的地址前缀        $imagesPrefix = $_SERVER['DOCUMENT_ROOT'] . '/attachment/';        // 组合本地暂存文件地址        $qrCodePath = $qrCodeFolder . $qrCodeName;        // 生成二维码        QRcode::png($content, $qrCodePath, $errorCorrectionLevel, 5.21);        // 鸡类        $chicken = new Chicken_EweiShopV2Page();        // 获取用户信息        $userInfo = $chicken->getInfo(true);        // 设置生成心情卡的配置        // 背景        $backgroundPath =   tomedia($_GPC['__input']['background']);        // 照片        $picturePath =   tomedia( $_GPC['__input']['picture']);        // 头像文件夹        $saveFolder = __DIR__ . '/../../static/mobile/portrait/';        // 头像        $portraitPath = $saveFolder . $_W['uniacid'] . '-' . $_W['openid'] . '.jpg';        // 昵称        $nickname = $userInfo['name'];        // 个性签名        $autograph = $_GPC['__input']['autograph'];        // 是否保存到服务器        $save = true;        // 保存地址        $saveFolder = __DIR__ . '/../../static/mobile/mood/';        // 判断该文件夹是否存在        if (!file_exists($saveFolder)) {            // 不存在则生成文件夹            mkdir($saveFolder, 0777, true);        }        // 设置保存文件名称        $saveName = $_W['uniacid'] . '-' . $_W['openid'] . '.png';        // 访问该图片的url        $imageUrl = $_W['siteroot'] . 'addons/ewei_shopv2/plugin/open_farm/static/mobile/mood/' . $saveName;        // 设置保存文件地址        $savePath = $saveFolder . $saveName;        // 引入心情卡工具类        require_once __DIR__ . '/mood_image.php';        // 生成心情卡        $info = MoodImage::main($backgroundPath, $picturePath, $portraitPath, $qrCodePath, $nickname, $autograph, $save, $savePath);        // 删除本地暂存二维码        unlink($qrCodePath);        if ($save) {            $this->model->returnJson(                $imageUrl,                false,                '生成成功!'            );        }    }}