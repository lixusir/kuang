<?php/* * 人人商城 * * 青岛易联互动网络科技有限公司 * http://www.we7shop.cn * TEL: 4000097827/18661772381/15865546761 */if (!defined('IN_IA')) {    exit('Access Denied');}class Surprised_EweiShopV2Page extends PluginMobilePage {    /**     * 当前数据表名称     * @var string     */    private $table = 'ewei_open_farm_surprised';    /**     * 当前类的所有字段     * @var array     */    private $field = array(        'id',        'uniacid',        'value',        'category',        'probability',        'create_time',    );    /**     * 删除彩蛋     * @param $id     * @return bool     */    public function deleteInfo($id) {        global $_W, $_GPC;        $query = pdo_delete($this->table, array('id' => $id));        return $query;    }    /**     * 删除用户彩蛋     */    public function deleteUserSurprised() {        global $_W, $_GPC;        $id = $_GPC['__input']['id'];        $table = 'ewei_open_farm_user_surprised';        $query = pdo_delete($table, array('id' => $id));        $this->model->returnJson($query);    }    /**     * 删除用户彩蛋     * @param $id     */    public function deleteInfoByCoupon($id) {        global $_W, $_GPC;        // 根据优惠券id查询所有彩蛋        $where = array(            'uniacid' => $_W['uniacid'],            'category' => '优惠券',            'value' => $id,        );        $infoArr = pdo_getall($this->table, $where);        // 删除彩蛋        pdo_delete($this->table, $where);        // 收集所有彩蛋id        $infoIdArr = array();        foreach ($infoArr as $key => $value) {            $infoIdArr[] = $value['id'];        }        $infoIdStr = implode(',', $infoIdArr);        $table = 'ewei_open_farm_user_surprised';        $tableName = tablename($table);        // 删除所有用户彩蛋        $sql = " DELETE FROM {$tableName} " .            " WHERE `surprised_id` IN ({$infoIdStr}) " .            " AND `uniacid` = {$_W['uniacid']} ";        pdo_query($sql);    }    /**     * 删除无效彩蛋     * @return string     */    public function clearCouponSurprised() {        global $_W;        $where = array(            'uniacid' => $_W['uniacid'],            'category' => '优惠券',        );        $surprisedArr = pdo_getall($this->table, $where);        $couponIdArr = array();        foreach ($surprisedArr as $key => $value) {            $couponIdArr[] = $value['value'];        }        $couponIdStr = implode(',', $couponIdArr);        // 查询所有优惠券信息        $table = 'ewei_shop_coupon';        $tableName = tablename($table);        $sql = " SELECT * FROM {$tableName} " .            " WHERE `uniacid` = {$_W['uniacid']} " .            " AND `id` IN ({$couponIdStr}) ";        $couponArr = pdo_fetchall($sql);        // 循环判断        foreach ($couponArr as $key => $value) {            // 判断优惠券数量为空的            if ($value['total'] === 0) {                $this->deleteInfoByCoupon($value['id']);            }        }    }}